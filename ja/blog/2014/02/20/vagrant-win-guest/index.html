<!doctype html>
<html lang="ja">


<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順 - てっく煮ブログ</title>
	<!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" />
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
	<meta property="og:title" content="Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順"/>
	<meta property="og:url" content="http://tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/"/>
	<meta property="og:type" content="article"/>
	<meta property="og:description" content="最近話題の Vagrant さんは「Linux の環境を作ったり壊したりして開発とか試験が楽になるよ」と紹介されることが多いけど、Windows の環境だって作ったり壊したりしたい！いろいろ調べつつ環境を作ってみたので、その手順を共有しておく。完成イメージはこんな感じ。コマンドプロンプトから vagrant up をしたら VirtualBox 上に Windows Server 2012 R2 の環境が準備されて、そこにリモート デスクトップで接続している。いろいろいじったあとに vagrant destroy したら環境は消え去って、vagrant up したら、また、まっさらな状態..."/>
	<meta property="og:image" content="http://farm4.staticflickr.com/3785/12637800714_1f99876e85_o.png"/>
	<meta property="og:site_name" content="てっく煮ブログ"/>
	<meta property="fb:admins" content="1297551349" />
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="nitoyon">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<link rel="alternate" type="application/rss+xml" title="RSS" href="/ja/blog/index.xml" />
</head>
<body class="ja">
<header class="wrap page-header">
<div class="wrapped">
	<h1 id="logo">
		
		<a href="/ja/blog/" id="logo-blog-ja">てっく煮ブログ</a>
		
	</h1>
	<nav>
		<ul>
<li class="home"><a href="/ja/">HOME</a></li><li class="about"><a href="/ja/about/">ABOUT</a></li><li class="blog"><a href="/ja/blog/">BLOG(ja)</a></li><li class="blog-en"><a href="/en/blog/">BLOG(en)</a></li>
		</ul>
	</nav>
</div>
</header>
<div class="wrap">
<div class="wrapped">

<article>
<header>
<div class="post-date">2014年02月20日</div>

<div class="post-tags"><a href="/ja/blog/tags/windows/">Windows</a></div>

<h1>Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順</h1>


<div class="share">
	<a href="http://b.hatena.ne.jp/entry/tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" class="hatena-bookmark-button" data-hatena-bookmark-title="Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順 - てっく煮ブログ"  data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
	<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" data-lang="ja" data-size="horizontal" data-text="Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順 - てっく煮ブログ" data-related="nitoyon" data-dnt="true">Tweet</a>
	<div class="fb-like" data-href="http://tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" data-send="false" data-layout="button_count" data-width="90" data-show-faces="false"></div>
</div>

</header>

<div id="entry">
<div class="entry-body">
<section>
<p>最近話題の <a href="http://www.vagrantup.com/">Vagrant</a> さんは「Linux の環境を作ったり壊したりして開発とか試験が楽になるよ」と紹介されることが多いけど、Windows の環境だって作ったり壊したりしたい！</p>

<p>いろいろ調べつつ環境を作ってみたので、その手順を共有しておく。</p>

<p>完成イメージはこんな感じ。コマンドプロンプトから <code>vagrant up</code> をしたら VirtualBox 上に Windows Server 2012 R2 の環境が準備されて、そこにリモート デスクトップで接続している。</p>

<p><center><img src="http://farm4.staticflickr.com/3750/12637326905_8f2cfe0da7.jpg" width="500" height="365"></center></p>

<p>いろいろいじったあとに <code>vagrant destroy</code> したら環境は消え去って、<code>vagrant up</code> したら、また、まっさらな状態から使える。</p>

<p>ちょっと注目してほしいのは、ゲスト OS の <code>C:\vagrant</code> にホスト側の <code>Vagrantfile</code> がマウントされているところ。このあたりの処理は <a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> というプラグインがうまくやってくれている。このプラグインのおかげで、Linux と同じように <code>Vagrantfile</code> を設定してやると、ホスト名を変更したり、IP アドレスを指定してネットワーク アダプターを追加したり、ホスト側の Chef のレシピを <code>vagrat provision</code> を使って、ゲスト上で走らせたりできるようになる。</p>

<h1>目次</h1>

<p>最初に目次をドーン。</p>

<ol>
<li>VirtualBox をインストールする</li>
<li>Vagrant をインストールする</li>
<li>ゲスト OS をインストールする</li>
<li>Vagrant-Windows 用の設定を行う</li>
<li>Base Box を作成する</li>
<li>Base Box を試す</li>
</ol>

<p>正直いって長い。Linux ならネットに転がっている Box を使って「ハイ終わり」なんだけど、Windows の場合は自分で Box を作らなきゃいけないので、こんな長い手順になっている。</p>

<p>ゲスト OS は Windows 8.1 Pro 64bit と Windows Server 2012 R2 Standard を試してみた。</p>

<p>ホスト OS は Windows 8.1 Pro x64 を使っている。試してないけど Windows 以外の OS でも VirtualBox と Vagrant が動くならいけると思う。</p>

<p>なるべく一次情報を併記しつつ手順を示すので、バージョンが違うときにも応用はきくはずだ。また、裏側で何が起こっているのかを調べてみたので、うまくいかないときには参考にしてほしい。</p>

<p>では、さっそく行ってみよう。</p>

<h1>1. VirtualBox をインストールする</h1>

<p>VirtualBox を次の場所からダウンロードする。</p>

<ul>
<li><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></li>
</ul>

<p>執筆時点で最新の 4.3.6 をインストールした。</p>

<p>すべてデフォルトでインストールしたら、<code>C:\Program Files\Oracle\VirtualBox</code> にインストールされた。</p>

<h3>補足</h3>

<p>Vagrant が対応している VirtualBox をインストールしなきゃいけない。</p>

<p><a href="http://docs.vagrantup.com/v2/virtualbox/index.html">VirtualBox Provider - Vagrant Documentation</a> に Vagrant が要求する VirtualBox のバージョンが書いてある。執筆時点 (2014年2月) は次のようになっている。</p>

<blockquote>
<p>The VirtualBox provider is compatible with VirtualBox versions 4.0.x, 4.1.x, 4.2.x, and 4.3.x.</p>
</blockquote>

<h2>パスを通す</h2>

<p>Vagrant さんは <code>C:\Program Files\Oracle\VirtualBox\VBoxManage.exe</code> を使って VirtualBox に色んな指令をだす。</p>

<p>パスが通ってないとエラーになるので、<code>C:\Program Files\Oracle\VirtualBox</code> にパスを通しておく。</p>

<h1>2. Vagrant をインストールする</h1>

<p>Vagrant のインストーラーを次の場所から取得して、すべてデフォルトでインストールする。</p>

<ul>
<li><a href="http://www.vagrantup.com/downloads.html">http://www.vagrantup.com/downloads.html</a></li>
</ul>

<p>執筆時点で最新の 1.4.3 を利用した。</p>

<p><center><img src="http://farm4.staticflickr.com/3785/12637800714_643944ef04.jpg" width="500" height="390"></center></p>

<p>Vagrant は <code>C:\HashiCorp\Vagrant</code> にインストールされる。自動で、<code>C:\HashiCorp\Vagrant\bin</code> にパスが通る。<code>C:\HashiCorp\Vagrant\embedded</code> に ruby や mingw などの UNIX 環境が入る。</p>

<h2>Vagrant-Windows プラグイン</h2>

<p>Vagrant で Windows をゲスト OS として扱うために、<a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> プラグインを導入しておく。</p>

<p>コマンドプロンプトから次のコマンドを実行する。</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt;vagrant plugin install vagrant-windows
Installing the 'vagrant-windows' plugin. This can take a few minutes...
Installed the plugin 'vagrant-windows (1.5.1)'!
</code></pre></div>
<p>Vagrant-Windows の 1.5.1 がインストールされた。</p>

<h3>補足</h3>

<p>プラグインの gem は <code>C:\Users\username\.vagrant.d\gems\gems</code> に展開される。</p>

<h1>3. ゲスト OS をインストールする</h1>

<p>UNIX 系の OS だと、<a href="http://www.vagrantbox.es/">Vagrantbox.es</a> から Base Box (Vagrant 用のイメージ) を拾ってくればいいんだけど、Windows だとそうもいかない。自分で Base Box を作るところから始まる。</p>

<p>Base Box を作るときの注意点は <a href="http://docs.vagrantup.com/v2/boxes/base.html">Creating a Base Box - Vagrant Documentation</a> にある。ざっと要約すると</p>

<ul>
<li>ディスク サイズは大きめにしてね。VirtualBox なら [可変サイズ] のディスクを大きめのサイズで作ってね。</li>
<li>メモリーは大きすぎない値にしてね。ユーザーは <code>Vagrantfile</code> で変更できるんだから、512MB ぐらいにしておいてね。</li>
<li>オーディオとか USB は無効にしてね。</li>
<li><code>vagrant</code> というユーザー (パスワードも <code>vagrant</code>) を作ってね。<code>authorized_keys</code> に追加してね。<code>sudoers</code> に追加してね。<code>root</code> のパスワードも <code>vagrant</code> にしてね。</li>
</ul>

<p>といったことが書いてある。これに従って作業してみる。</p>

<h2>仮想マシンの作成</h2>

<p>次の手順で実施した。インストールメディアの ISO ファイルがあるものとする。</p>

<ol>
<li>VirtualBox を起動する。</li>
<li>メニューから [仮想マシン] &gt; [新規] で新しい仮想マシンを作る。</li>
<li>名前とバージョンを選択して、[次へ] を押す。

<ul>
<li>Windows Server 2012 R2 のとき: 名前は [Windows 2012 R2]、バージョンは [Windows 2012 (64bit)]。</li>
<li>Windows 8.1 のとき: 名前は [Windows 8.1]、バージョンは [Windows 8.1 (64bit)]。</li>
</ul></li>
<li>メモリーは 2048MB を提案されるので、1024MB に減らして [次へ] を押す。

<ul>
<li>512MB まで減らすと、Windows 8.1 で 0xc0000017、Windows Server 2012 R2 で 0xE0000100 エラーが出て先に進めなかった。</li>
</ul></li>
<li>ハードドライブはデフォルトで 25GB の可変サイズで [作成]、[次へ] を押していく。</li>
<li>新しくできた仮想マシン [Windows 2012 R2] を選択して、メニューから [仮想マシン] &gt; [設定] を選ぶ。</li>
<li>オーディオと USB を無効にする。

<ul>
<li>[オーディオ] を選択して、[オーディオを有効化] のチェックを外す。</li>
<li>[USB] を選択して、[USB コントローラーを有効化] のチェックを外す。</li>
</ul></li>
<li>ISO イメージを割り当てる。

<ul>
<li>[ストレージ] を選択する。</li>
<li>[コントロｰラー: IDE] の下の [空] を選択する。</li>
<li>[CD/DVD ドライブ] の右側のディスクのアイコンをクリックして、[仮想CD/DVDディスクファイルの選択...] を選ぶ。</li>
<li>インストールメディアの ISO ファイルを選ぶ。</li>
</ul></li>
<li>[OK] を押して閉じる。</li>
</ol>

<h2>OS のインストール</h2>

<p>引き続き、OS のインストールを行う。</p>

<ol>
<li>メニューから [仮想マシン] &gt; [起動] で仮想マシンを起動する。</li>
<li>ISO イメージから起動するので、デフォルトの設定でインストールを始める。</li>
<li>(2012 R2 のみ) OS の種類は [Windows Server 2012 R2 Standard (GUI 使用サーバー)] を選択して、[次へ]。</li>
<li>インストールの種類は [カスタム: Windows のみをインストールする (詳細設定)] を選ぶ。

<ul>
<li>インストールが始まるので、しばらく待つ。</li>
</ul></li>
<li>アカウントのパスワードを設定する。

<ul>
<li>Windows Server 2012 R2: Administrator アカウントのパスワードを決める画面になるので、適当に入力する (この時点では &quot;vagrant&quot; は「簡単すぎる」と怒られるので設定できない)。</li>
<li>Windows 8.1: Microsoft アカウントは登録しない。ローカルアカウントをユーザー名 vagrant、パスワード vagrant で登録する。</li>
</ul></li>
<li>ログオン画面になるので、作成したアカウントでログオンする。

<ul>
<li>Ctrl + Alt + Del は「右 Ctrl + Del」で入力する。メニューから [仮想マシン] &gt; [Ctrl-Alt-Delを送信] でもよい。</li>
</ul></li>
<li><p>Guest Additions をインストールする。</p>

<ul>
<li>メニューから [デバイス] &gt; [Guest Additions のCDイメージを挿入...] を選ぶ。</li>
<li>D: ドライブを開いて、Guest Additions のセットアップを行う。</li>
<li>作業が終わったら、[デバイス] &gt; [CD/DVD デバイス] &gt; [仮想ドライブからディスクを除去] でディスクを抜いておく。</li>
</ul></li>
</ol>

<h1>4. Vagrant-Windows 用の設定を行う</h1>

<p>ゲスト OS 側にいろんな設定を行う。</p>

<p>Linux 側の手順でいうところの</p>

<ul>
<li><code>vagrant</code> というユーザー (パスワードも <code>vagrant</code>) を作ってね。<code>authorized_keys</code> に追加してね。<code>sudoers</code> に追加してね。<code>root</code> のパスワードも <code>vagrant</code> にしてね。</li>
</ul>

<p>の作業をやるのだが、Windows の場合は SSH ではなく WinRM を使う。</p>

<p>詳しい手順は <a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> のページに書いてあるので、この手順に従って、ちまちまと作業を行う。</p>

<blockquote>
<ul>
<li>Create a vagrant user, for things to work out of the box username and password should both be &quot;vagrant&quot;.</li>
<li>Turn off UAC (Msconfig)</li>
<li>Disable complex passwords</li>
<li><a href="http://www.jppinto.com/2010/01/how-to-disable-the-shutdown-event-tracker-in-server-20032008/">Disable Shutdown Tracker</a> on Windows 2008/2012 Servers (except Core).</li>
<li><a href="http://www.elmajdal.net/win2k8/How_to_Turn_Off_The_Automatic_Display_of_Server_Manager_At_logon.aspx">Disable &quot;Server Manager&quot; Starting at login</a> on Windows 2008/2012 Servers (except Core).</li>
<li>Enable and configure WinRM (see below)</li>
</ul>
</blockquote>

<h2>パスワードの複雑性を無効にする</h2>

<p>Windows Server 2012 R2 のみ。</p>

<ol>
<li>サーバー マネージャーのメニューから [ツール] &gt; [ローカル セキュリティー ポリシー] を選択する。</li>
<li>[アカウント ポリシー] &gt; [パスワードのポリシー] &gt; [複雑さの要件を満たす必要があるパスワード] をダブルクリックして [無効] に設定する。</li>
<li>Ctrl-Alt-Del から Administrator のパスワードを <code>vagrant</code> に変更しておくとよい。</li>
</ol>

<h2>ユーザー vagrant を作成する</h2>

<p>Windows Server 2012 R2 のみ。</p>

<ol>
<li>サーバー マネージャーのメニューから [ツール] &gt; [コンピューターの管理] を選択する。</li>
<li>[システム ツール] &gt; [ローカル ユーザーとグループ] &gt; [ユーザー] を選択する。</li>
<li>右クリックから [新しいユーザー] を選択する。</li>
<li>ユーザーを作成する。

<ul>
<li>ユーザー名、パスワードを <code>vagrant</code> にする。</li>
<li>[ユーザーは次回ログオン時にパスワードの変更が必要] のチェックを外す。</li>
<li>[パスワードを無期限にする] をチェックする。</li>
<li>[作成] ボタンを押す。</li>
</ul></li>
<li>管理者に変更する。

<ul>
<li>新しく作成した <code>vagrant</code> 右クリックして [プロパティ] を選択する。</li>
<li>[所属するグループ] タブを開く。</li>
<li><code>Administrators</code> を追加して、[Users] を削除する。</li>
<li>[OK] ボタンを押す。</li>
</ul></li>
</ol>

<h2>UAC を無効にする</h2>

<p>Windows Server 2012 R2、Windows 8.1 共通。</p>

<ol>
<li>msconfig を起動する。たとえば、Windows + R で [ファイル名を指定して実行] を開いて、<code>msconfig</code> と入力して [OK] を押す。</li>
<li>[ツール] タブを開いて、[UAC 設定の変更] を選択して、[起動] ボタンを押す。</li>
<li>スライダーを一番下の [通知しない] にして、[OK] ボタンを押す。</li>
</ol>

<h2>Shutdown Tracker を無効にする</h2>

<p>Windows Server 2012 R2 のみ。</p>

<ol>
<li>[ローカル グループ ポリシー エディター] を起動する。たとえば、Windows + R で [ファイル名を指定して実行] を開いて、<code>gpedit.msc</code> と入力して [OK] を押す。</li>
<li>ツリーから [コンピューターの構成] &gt; [管理者用テンプレート] &gt; [システム] を選択する。</li>
<li>右側のペインから [シャットダウン イベントの追跡ツールを表示する] をダブルクリックする。</li>
<li>[未構成] を [無効] に変更して、[OK] ボタンを押す。</li>
</ol>

<h2>ログオン後にサーバー マネージャーが表示されないようにする</h2>

<p>Windows Server 2012 R2 のみ。</p>

<ol>
<li>[ローカル グループ ポリシー エディター] を起動する。たとえば、Windows + R で [ファイル名を指定して実行] を開いて、<code>gpedit.msc</code> と入力して [OK] を押す。</li>
<li>ツリーから [コンピューターの構成] &gt; [管理者用テンプレート] &gt; [システム] &gt; [サーバー マネージャー] を選択する。</li>
<li>右側のペインから [ログオン時にサーバー マネージャーを自動的に表示しない] をダブルクリックする。</li>
<li>[未構成] を [有効] に変更して、[OK] ボタンを押す。
5．コマンドプロンプトから <code>gpupdate</code> を実行して、その場でポリシーを反映する。</li>
</ol>

<h2>WinRM を有効にする</h2>

<p>Windows Server 2012 R2、Windows 8.1 共通。</p>

<p>コマンドプロンプト上で次のコマンドを実行する。</p>
<div class="highlight"><pre><code class="language-" data-lang="">winrm quickconfig -q
winrm set winrm/config/winrs @{MaxMemoryPerShellMB="512"}
winrm set winrm/config @{MaxTimeoutms="1800000"}
winrm set winrm/config/service @{AllowUnencrypted="true"}
winrm set winrm/config/service/auth @{Basic="true"}
sc config WinRM start= auto
</code></pre></div>
<p>Windows Server 2008 では追加の設定が必要になるようなので、<a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> を参照のこと。</p>

<h2>設定しておいたほうが便利そうなこと</h2>

<p><a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> の手順には書いてなかったが、やっておいたほうがよいかもしれないのは次の手順。</p>

<ul>
<li>リモートデスクトップを有効にする: ヘッドレスで利用する場合は、リモートデスクトップでつなぐことになる。いずれにしても有効にしておいたほうが便利だろう。</li>
<li>Windows Update をとめる: 自動でダウンロードしたりインストールしたりする設定は OFF にしておくと、いきなり端末が重くなって悩まされない。</li>
</ul>

<h1>4. Base Box を作成する</h1>

<p>ここまでで準備は完了。ゲスト OS は電源を切っておく。</p>

<p>ホスト OS 側でイメージを Base Box としてパッケージ化していく。</p>

<h2>デフォルトの Vagrantfile を用意</h2>

<p>Box に <code>Vagrantfile</code> を同梱したいので、次の中身を <code>Vagrantfile.txt</code> として保存しておく。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">guest</span> <span class="o">=</span> <span class="ss">:windows</span>
<span class="k">end</span>
</code></pre></div>
<p>「ゲスト OS は Windows だよ」「Vagrant-Windows を使ってゲスト OS に指令をだしてね」という意味だ。</p>

<p>この手順は省略してもよいんだけど、省略した場合は、プロジェクトを作るたびに上の設定を <code>Vagrantfile</code> に書く必要がある (忘れてしまうと、電源起動以外がうまく動かない)。</p>

<h3>参考情報</h3>

<ul>
<li><a href="http://docs.vagrantup.com/v2/vagrantfile/">Vagrantfile - Vagrant Documentation</a>: <code>Vagrantfile</code> の優先順位について書いてある。プロジェクトごとの <code>Vagrantfile</code> に設定がない場合は、Box の <code>Vagrantfile</code> を見に行くそうだ。</li>
</ul>

<h2>vagrant package で Box を作成</h2>

<p>コマンドプロンプトで次のように入力するだけ。</p>
<div class="highlight"><pre><code class="language-" data-lang="">C:\Users\username&gt;vagrant package --base "Windows 2012 R2" --vagrantfile Vagrantfile.txt
[Windows 2012 R2] Clearing any previously set forwarded ports...
[Windows 2012 R2] Exporting VM...
[Windows 2012 R2] Compressing package to: C:/Users/username/package.box```
</code></pre></div>
<p>カレントディレクトリに <code>package.box</code> というファイル名で出力される。<code>Win2012R2.box</code> や <code>Win81.box</code> などにリネームしておくと分かりやすいだろう。</p>

<h3>補足</h3>

<ul>
<li><code>Windows 2012 R2</code> の部分は VirtualBox の仮想マシン名なので、別名で作った場合は適宜変更すべし。</li>
<li>Vagrantfile.txt が別のディレクトリーにあるときは、そこへのパスを入力すべし。</li>
<li>Vagrantfile を同梱しない場合は、<code>--vagrantfile</code> の指定は不要。</li>
</ul>

<h3>裏側の挙動</h3>

<p>それなりの時間がかかる。内部的には次のような処理をしている様子。</p>

<ol>
<li>ディスクイメージ (この時点で約 8GB) を <code>C:\Users\username\.vagrant.d\tmp</code> の下に圧縮した vmdk として出力する (4GB に圧縮)。</li>
<li><code>box.ovf</code> と <code>Vagrantfile</code> も同じ場所に設置。</li>
<li>tar でカレントディレクトリに <code>package.box</code> として固めて出力。</li>
</ol>

<h3>参考情報</h3>

<ul>
<li><a href="http://docs.vagrantup.com/v2/virtualbox/boxes.html">Creating a Base Box - VirtualBox Provider - Vagrant Documentation</a>: パッケージ化の方法</li>
<li><a href="http://docs.vagrantup.com/v2/cli/package.html">vagrant package - Command-Line Interface - Vagrant Documentation</a>: <code>vagrant package</code> のコマンドライン オプション。</li>
</ul>

<h1>5. Base Box を試す</h1>

<p>ここからは他の OS の Base Box を試す手順とかなり似てくる。</p>

<h2>vagrant box add</h2>

<p>次のコマンドで Box を作成する。</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt; vagrant box add Win2012R2 path\to\package.box
Downloading box from URL: file:C:/Users/username/package.box
Extracting box...ate: 124M/s, Estimated time remaining: --:--:--)
Successfully added box 'Win2012R2' with provider 'virtualbox'!
</code></pre></div>
<p><code>path\to\package.box</code> の部分は 4. で作成した box ファイルへのパスに置き換えて実行してね。</p>

<h3>補足</h3>

<p><code>package.box</code> を Web サーバー上に置いた場合は <code>vagrant box add BoxName http://example.com/package.box</code> のように指定できる。Web 上に公開された Box ファイルの情報を寄せ集めたのが <a href="http://www.vagrantbox.es/">Vagrantbox.es</a> である。</p>

<h3>裏側の挙動</h3>

<p><code>C:\Users\username\.vagrant.d\boxes\Win2012R2\virtualbox</code> に box ファイルの中身が展開される。</p>

<h2>vagrant init</h2>

<p>プロジェクトのディレクトリーを適当に作って、<code>vagrant init</code> する。</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt;cd C:\Users\username\Documents
&gt;mkdir Win2012R2
&gt;cd Win2012R2
&gt;vagrant init Win2012R2
A `Vagrantfile` has been placed in this directory. You are now
ready to `vagrant up` your first virtual environment! Please read
the comments in the Vagrantfile as well as documentation on
`vagrantup.com` for more information on using Vagrant.
</code></pre></div>
<p><code>Vagrantfile</code> がカレントディレクトリーに出力される。</p>

<p>ゲスト OS の画面を表示する方法を</p>

<ul>
<li>VirtualBox のウインドウを表示する</li>
<li>リモートデスクトップする</li>
</ul>

<p>のいずれを選ぶかに応じて、<code>Vagrantfile</code> の設定手順が変わる。</p>

<p>VirtualBox のウインドウを表示する場合は、次のように <code># Don&#39;t boot with headless mode</code> の部分のコメントを取り除いておく。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
    <span class="c1"># Don't boot with headless mode</span>
    <span class="n">vb</span><span class="p">.</span><span class="nf">gui</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Use VBoxManage to customize the VM. For example to change memory:</span>
    <span class="c1">#vb.customize ["modifyvm", :id, "--memory", "1024"]</span>
  <span class="k">end</span>
</code></pre></div>
<p>リモートデスクトップを利用する場合は、次のような設定を書いておく。</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

  <span class="c1"># Port forward RDP</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:forwarded_port</span><span class="p">,</span> <span class="ss">guest: </span><span class="mi">3389</span><span class="p">,</span> <span class="ss">host: </span><span class="mi">13389</span>

  <span class="c1"># ここより下は省略...</span>
<span class="k">end</span>
</code></pre></div>
<p>ゲストの電源を入れたあと、ホスト上のリモートデスクトップ クライアントを立ち上げて <code>localhost:13389</code> に繋ぎに行けばよい。詳しくは <a href="/ja/blog/2014/02/06/rdp-port/">リモート デスクトップでポート番号を指定して接続する方法</a> を参照してほしい。なお、<a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> にはホスト側を <code>3389</code> とする設定例が載っていたが、それではうまく動かなかった。</p>

<h2>vagrant up</h2>

<p>いよいよ起動。</p>
<div class="highlight"><pre><code class="language-" data-lang="">&gt; vagrant up
Bringing machine 'default' up with 'virtualbox' provider...
[default] Clearing any previously set forwarded ports...
[default] Clearing any previously set network interfaces...
[default] Preparing network interfaces based on configuration...
[default] Forwarding ports...
[default] -- 3389 =&gt; 13389 (adapter 1)
[default] Booting VM...
[default] Waiting for machine to boot. This may take a few minutes...
[default] Machine booted and ready!
[default] Mounting shared folders...
[default] -- /vagrant
[default] VM already provisioned. Run `vagrant provision` or use `--provision` t
o force it
</code></pre></div>
<p><code>vagrant up</code> すると端末が上がってくる。</p>

<p><center><img src="http://farm4.staticflickr.com/3750/12637326905_8f2cfe0da7.jpg" width="500" height="365"></center></p>

<h3>補足</h3>

<ul>
<li>コピーが発生するので初回は少し待つ。</li>
<li>VirtualBox を起動しておくと、イメージが登録されて起動してくる様子を確認できる。</li>
<li>ログオンしてみると、<code>C:\vagrant</code> にホスト側のプロジェクト ディレクトリーが見えているのが確認できる。</li>
</ul>

<h3>裏側の挙動</h3>

<ul>
<li><code>C:\Users\username\.vagrant.d\boxes\Win2012R2\virtualbox</code> の中身を <code>C:\Users\username\VirtualBox VMs</code> にコピーする。</li>
<li>上記イメージを VirtualBox に登録して、電源が入る。</li>
<li>プロジェクト ディレクトリーが <code>C:\vagrant</code> で見えているのは「VirtualBox の共有フォルダーの機能」と「<a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> が共有へのシンボリックリンクを作る機能」の合わせ技で実現している。シンボリックリンクは WinRM で <a href="https://github.com/WinRb/vagrant-windows/blob/v1.5.1/lib/vagrant-windows/scripts/mount_volume.ps1.erb"><code>mount_volume.ps1</code></a> を実行して作成している。</li>
</ul>

<h1>まとめ</h1>

<p>以上で手順の解説は終わる。このあとは <code>Vagrantfile</code> を編集していろいろ試すとよい。</p>

<p><a href="https://github.com/WinRb/vagrant-windows">Vagrant-Windows</a> が頑張ってくれているおかげで、Linux と同じように Vagrant の機能を使えることがわかった。手順が面倒だったのは、ライセンス上の問題で Windows の Box がネットに落ちていないから。</p>

<p>実際に使ってみると、VirtualBox がたまに落ちたり、ゲスト OS 内で <code>VirtualBoxService.exe</code> や <code>rundll32.exe aepdu.dll,AePduRunUpdate</code> が CPU を消費しまくっている現象が起きたりして悲しい。VirtualBox や Windows の問題なので、Vagrant は悪くない。</p>

</section>

</div>

<footer>

<div id="post-ad">
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle my_adslot_1"
     style="display:inline-block"
     data-ad-client="ca-pub-5030829344952718"
     data-ad-slot="4154719447"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
<ins class="adsbygoogle my_adslot_2"
     style="display:inline-block"
     data-ad-client="ca-pub-5030829344952718"
     data-ad-slot="5631452649"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

</div>

<div class="share">

<div class="share">
	<a href="http://b.hatena.ne.jp/entry/tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" class="hatena-bookmark-button" data-hatena-bookmark-title="Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順 - てっく煮ブログ"  data-hatena-bookmark-layout="standard" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
	<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" data-lang="ja" data-size="horizontal" data-text="Vagrant で作ったり壊したりできる Windows 環境を手に入れるまでの手順 - てっく煮ブログ" data-related="nitoyon" data-dnt="true">Tweet</a>
	<div class="fb-like" data-href="http://tech.nitoyon.com/ja/blog/2014/02/20/vagrant-win-guest/" data-send="false" data-layout="button_count" data-width="90" data-show-faces="false"></div>
</div>

</div>

<div class="entry-data">
<div class="post-date">2014年02月20日 <span class="edit-history"><a href="https://github.com/nitoyon/tech.nitoyon.com/commits/master/_posts/ja/2014-02-20-vagrant-win-guest.md">編集履歴</a></span></div>

<div class="post-tags"><a href="/ja/blog/tags/windows/">Windows</a></div>
</div>


<div class="seealso">
<h4>関連する記事</h4>
<ul>

<li><a href="/ja/blog/2014/02/06/rdp-port/">リモート デスクトップでポート番号を指定して接続する方法</a></li>

<li><a href="/ja/blog/2014/01/17/chef-win-path/">Windows で Chef するときに PATH で混乱しないように専用のコンソールを作った</a></li>

<li><a href="/ja/blog/2013/12/09/setctime/">Windows でファイル作成日時をスクリプト言語から操作するために setctime.exe を作った</a></li>

<li><a href="/ja/blog/2013/11/14/jekyll-win/">Windows で Jekyll 1.3 を動かすまでの手順</a></li>

<li><a href="/ja/blog/2011/09/18/no-flash-on-metro-ie10/">IE10 Metro 版では Flash が動かないので、いよいよ Flash 終わった感</a></li>

</ul>
</div>


<div id="pager">
	
	<div class="previous">
		<a href="/ja/blog/2014/02/06/rdp-port/" rel="previous"><b>&laquo;</b><span class="title">リモート デスクトップでポート番号を指定して接続する方法</span></a>
	</div>
	
	
	<div class="next">
		<a href="/ja/blog/2014/02/25/jenkins-home-win/" rel="next"><span class="title">Windows の Jenkins で JENKINS_HOME を別のフォルダーに変更する方法</span><b>&raquo;</b></a>
	</div>
	
</div>

<div id="disqus_thread"></div>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</footer>
</div><!--entry-->

</article>

</div>
</div>

<footer class="page-footer">
<h2>About</h2>
<div class="wrapped">
<div id="footer-right-column" class="column">
	<div id="profile">
		<h3>Profile</h3>

		<a href="/about.html" id="prof_pic"><img alt="Photo" src="/img/icon/pic.jpg"></a>
		<p>nitoyon (にとよん)</p>
		<p>京都のベンチャー会社勤務。プログラマ、たまに趣味でデザイン。</p>
		<p class="seemore"><a href="/ja/about/">詳細</a></p>
	</div>

	
	<div id="subscribe">
		<h3>Subscribe</h3>
		<ul>
			<li><a href="https://twitter.com/nitoyon" class="twitter-icon32">twitter: @nitoyon</a></li>
			<li><a href="https://www.facebook.com/TechNiBlogJa" class="facebook-icon32">Facebook ページ</a></li>
			<li><a href="/ja/blog/index.xml" class="rss-icon32">RSS</a></li>
		</ul>
	</div>
</div>

<div id="footer-left-column" class="column">
	<div id="recententries">
		<h3>Recent Entries</h3>
		<ul id="recententries_list">
			<li><img src="/images/loading.gif"><noscript>(JavaScript required)</noscript></li>
		</ul>
	</div>
</div>
</div><!--wrapped-->

<div class="wrapped">
	<div id="archive">
	<h3>Archive</h3>
	<ul id="archive_month_list">
		<li><img src="/images/loading.gif"><noscript>(JavaScript required)</noscript></li>
	</ul>
	</div>
</div><!-- wrapped -->

<div class="wrap copy">
&copy; nitoyon 2002-2014. All rights reserved.
</div>
</footer>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/ja/posts.js"></script>
<script src="/javascripts/techni.js"></script>
<div id="fb-root"></div>
</body>
</html>